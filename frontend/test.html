<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thống Kê Chất Lượng Không Khí</title>
  <style>
    /* CSS từ trước */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9f9f9;
    }

    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #333;
      padding: 20px 20px;
      color: white;
    }

    .navbar h1 {
      margin: 0;
      font-size: 24px;
    }

    .navbar .nav-buttons {
      display: flex;
      gap: 20px;
    }

    .navbar .nav-buttons button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 999px;
      background-color: #4CAF50;
      color: white;
    }

    .navbar .nav-buttons button:hover {
      background-color: #45a049;
    }

    .navbar .nav-buttons button:active {
      background-color: #3e8e41;
    }

    .header-title {
      text-align: center;
      margin: 20px 0;
    }

    .header-title h2 {
      font-size: 24px;
      color: #333;
    }

    .container {
      width: 80%;
      margin: 0 auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }

    table th,
    table td {
      padding: 12px;
      border: 1px solid #ddd;
      text-align: center;
    }

    table th {
      background-color: #f2f2f2;
      font-weight: bold;
    }

    table tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .pagination {
      margin-top: 20px;
      text-align: center;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .pagination button {
      padding: 10px 20px;
      margin: 0 5px;
      border: 1px solid #ddd;
      background-color: #fff;
      cursor: pointer;
      border-radius: 5px;
    }

    .pagination button.active {
      background-color: #007bff;
      color: #fff;
    }

    /* CSS cho khối lọc */
    .filter-sort-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 20px 0;
      padding: 20px;
      /* Tăng độ dày của padding */
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #f9f9f9;
      height: 70px;
      /* Thêm chiều cao cho thanh chứa */
    }

    .filter-container,
    .sort-container {
      display: flex;
      align-items: center;
    }

    .filter-container label,
    .sort-container label {
      margin-right: 10px;
      font-weight: bold;
      color: #333;
      font-size: 16px;
      /* Tăng cỡ chữ */
    }

    .filter-container input,
    .sort-container select {
      padding: 8px;
      /* Tăng padding để cân đối với cỡ chữ */
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-right: 10px;
      font-size: 16px;
      /* Tăng cỡ chữ */
    }

    .filter-container input {
      width: 180px;
      /* Điều chỉnh lại kích thước để phù hợp với cỡ chữ */
    }

    .sort-container select {
      width: 220px;
      /* Điều chỉnh lại kích thước để phù hợp với cỡ chữ */
    }

    #applyFilter {
      padding: 8px 20px;
      /* Tăng padding để cân đối với cỡ chữ */
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      font-weight: bold;
      cursor: pointer;
      font-size: 16px;
      /* Tăng cỡ chữ */
      transition: background-color 0.3s;
    }

    #applySort {
      padding: 8px 20px;
      /* Tăng padding để cân đối với cỡ chữ */
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      font-weight: bold;
      cursor: pointer;
      font-size: 16px;
      /* Tăng cỡ chữ */
      transition: background-color 0.3s;
    }

    #applySort:hover {
      background-color: #0056b3;
    }

    #applyFilter:hover {
      background-color: #0056b3;
    }
  </style>
</head>

<body>
  <!-- Thanh navbar -->
  <div class="navbar">
    <h1>Quản lý nhà thông minh</h1>
    <div class="nav-buttons">
      <button id="homePage">Trang chủ</button>
      <button id="deviceHistoryBtn">Lịch sử thiết bị</button>
      <button id="information">Thông tin cá nhân</button>
    </div>
  </div>

  <!-- Bộ lọc thời gian và tùy chọn sắp xếp -->
  <div class="filter-sort-container">
    <!-- Bộ lọc thời gian -->
    <div class="filter-container">
      <label for="startDate">Từ ngày:</label>
      <input type="date" id="startTime">
      <label for="endDate">Đến ngày:</label>
      <input type="date" id="endTime">
      <button id="applyFilter">Lọc</button>
    </div>

    <!-- Sắp xếp -->
    <div class="sort-container">
      <label for="sortBy">Sắp xếp theo:</label>
      <select id="sortBy">
        <option value="none">Mặc định</option>
        <option value="temperatureAsc">Nhiệt độ (Tăng dần)</option>
        <option value="temperatureDesc">Nhiệt độ (Giảm dần)</option>
        <option value="humidityAsc">Độ ẩm (Tăng dần)</option>
        <option value="humidityDesc">Độ ẩm (Giảm dần)</option>
        <option value="lightIntensityAsc">Cường độ sáng (Tăng dần)</option>
        <option value="lightIntensityDesc">Cường độ sáng (Giảm dần)</option>
      </select>
      <button id="applySort">Sắp xếp</button>
    </div>
  </div>

  <!-- Tiêu đề -->
  <div class="header-title">
    <h2>Thống kê số liệu không khí</h2>
  </div>

  <div class="container">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Nhiệt độ (°C)</th>
          <th>Độ ẩm (%)</th>
          <th>Cường độ sáng (lux)</th>
          <th>Thời gian</th>
        </tr>
      </thead>
      <tbody id="air-quality-history"></tbody>
    </table>
    <div id="pagination" class="pagination">
      <button id="prev-page" onclick="changePage(-1)">←</button>
      <div id="page-numbers"></div>
      <button id="next-page" onclick="changePage(1)">→</button>
    </div>
  </div>

  <script>
    let airQualityHistoryFiltered = []; // Biến lưu trữ dữ liệu đã lọc
    let dataRendered = []; // Data để render dùng trong hàm renderPage
    let currentPage = 0; // Trang hiện tại
    let totalPages = 0; // Tổng số trang sau khi lọc

    // Tạo dữ liệu mẫu cho chất lượng không khí
    let airQualityHistory = Array.from({ length: 100 }, (_, i) => ({
      id: `ID${Math.floor(Math.random() * 1000).toString().padStart(3, '0')}`,
      temperature: (Math.random() * (40 - 20) + 20).toFixed(1),
      humidity: (Math.random() * (80 - 70) + 70).toFixed(1),
      lightIntensity: (Math.random() * (700 - 500) + 500).toFixed(0),
      time: new Date(Date.now() - Math.floor(Math.random() * 1e9)).toISOString()
    }));

    // Hàm phân trang
    function paginate(items, itemsPerPage) {
      const pages = [];
      for (let i = 0; i < items.length; i += itemsPerPage) {
        pages.push(items.slice(i, i + itemsPerPage));
      }
      return pages;
    }

    // Hàm hiển thị dữ liệu theo trang
    function renderPage(pageNumber) {
      const itemsPerPage = 10; // mỗi trang 10 dữ liệu  
      dataRendered = airQualityHistoryFiltered.length > 0 ? airQualityHistoryFiltered : airQualityHistory;
      const pagedHistory = paginate(dataRendered, itemsPerPage);

      // console.log(airQualityHistory, airQualityHistoryFiltered);

      totalPages = pagedHistory.length; // Cập nhật tổng số trang

      const airQualityTable = document.getElementById('air-quality-history');
      const pageNumbers = document.getElementById('page-numbers');

      // Hiển thị dữ liệu trong bảng
      airQualityTable.innerHTML = '';
      pagedHistory[pageNumber].forEach((data, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${data.id}</td>
          <td>${data.temperature}</td>
          <td>${data.humidity}</td>
          <td>${data.lightIntensity}</td>
          <td>${new Date(data.time).toLocaleString('vi-VN')}</td>
        `;
        airQualityTable.appendChild(tr);
      });

      // Hiển thị số trang với ... ngăn cách
      const maxPageButtons = 4;

      pageNumbers.innerHTML = '';
      function createPageButton(i, isCurrent = false) {
        const button = document.createElement('button');
        button.textContent = i + 1;
        button.className = isCurrent ? 'active' : '';
        button.addEventListener('click', () => renderPage(i));
        pageNumbers.appendChild(button);
      }

      if (totalPages <= maxPageButtons + 2) {
        for (let i = 0; i < totalPages; i++) {
          createPageButton(i, i === pageNumber);
        }
      } else {
        if (pageNumber < maxPageButtons - 1) {
          for (let i = 0; i < maxPageButtons; i++) {
            createPageButton(i, i === pageNumber);
          }
          pageNumbers.appendChild(document.createTextNode('...'));
          createPageButton(totalPages - 1);
        } else if (pageNumber >= totalPages - maxPageButtons + 1) {
          createPageButton(0);
          pageNumbers.appendChild(document.createTextNode('...'));
          for (let i = totalPages - maxPageButtons; i < totalPages; i++) {
            createPageButton(i, i === pageNumber);
          }
        } else {
          createPageButton(0);
          pageNumbers.appendChild(document.createTextNode('...'));
          for (let i = pageNumber - 2; i <= pageNumber + 1; i++) {
            createPageButton(i, i === pageNumber);
          }
          if (pageNumber + 1 < totalPages - 2) {
            pageNumbers.appendChild(document.createTextNode('...'));
          }
          createPageButton(totalPages - 1);
        }
      }

      // Cập nhật trạng thái nút mũi tên
      currentPage = pageNumber;
      document.getElementById('prev-page').disabled = pageNumber === 0;
      document.getElementById('next-page').disabled = pageNumber === totalPages - 1;
    }

    // Hàm thay đổi trang
    function changePage(delta) {
      const newPage = currentPage + delta;
      if (newPage >= 0 && newPage < totalPages) {
        renderPage(newPage);
      }
    }

    // Hàm lọc dữ liệu theo thời gian
    function filterData() {
      const startTimeInput = document.getElementById('startTime');
      const endTimeInput = document.getElementById('endTime');

      const startTime = new Date(startTimeInput.value).setHours(0, 0, 0, 0);
      const endTime = new Date(endTimeInput.value).setHours(23, 59, 59, 999);

      // Kiểm tra nếu ngày bắt đầu hoặc kết thúc bị để trống
      if (!startTimeInput.value || !endTimeInput.value) {
        alert("Vui lòng nhập đầy đủ ngày bắt đầu và ngày kết thúc.");
        return;
      }

      // Kiểm tra nếu ngày bắt đầu lớn hơn ngày kết thúc
      if (startTime > endTime) {
        alert("Ngày bắt đầu không thể lớn hơn ngày kết thúc.");
        return;
      }

      airQualityHistoryFiltered = airQualityHistory.filter(data => {
        const time = new Date(data.time);
        return time >= startTime && time <= endTime;
      });

      // Kiểm tra nếu không có dữ liệu phù hợp
      if (airQualityHistoryFiltered.length === 0) {
        alert("Không có dữ liệu nào phù hợp với khoảng thời gian bạn đã chọn.");
      }

      document.getElementById('sortBy').value = 'none';

      renderPage(0); // Hiển thị lại từ trang đầu sau khi lọc
    }

    // Hàm lọc mảng dữ liệu theo ngày dùng cho sắp xếp
    function findByDay(start, end) {
      const startTime = new Date(start);
      const endTime = new Date(end);

      startTime.setHours(0, 0, 0, 0);
      endTime.setHours(23, 59, 59, 999);

      return airQualityHistory.filter(item => {
        const time = new Date(item.time);
        return time >= startTime && time <= endTime;
      })
    }

    // Hàm sort data
    function sortData() {
      const sortBy = document.getElementById('sortBy').value;
      const start = document.getElementById('startTime').value;
      const end = document.getElementById('endTime').value;

      let data = [];

      // nếu đã có ô ngày thì lấy dữ liệu trong khoảng
      // nếu không thì lấy toàn bộ dữ liệu
      if(start && end) {
        data = findByDay(start, end);
      }
      else if ((!start && end) || (start && !end)) {
        alert('Không được để trống ô nhập ngày tháng');
        return;
      }
      else data = airQualityHistory;

      let sortedData = [];

      switch (sortBy) {
        case 'temperatureAsc':
          sortedData = data.sort((a, b) => a.temperature - b.temperature);
          break;
        case 'temperatureDesc':
          sortedData = data.sort((a, b) => b.temperature - a.temperature);
          break;
        case 'humidityAsc':
          sortedData = data.sort((a, b) => a.humidity - b.humidity);
          break;
        case 'humidityDesc':
          sortedData = data.sort((a, b) => b.humidity - a.humidity);
          break;
        case 'lightIntensityAsc':
          sortedData = data.sort((a, b) => a.lightIntensity - b.lightIntensity);
          break;
        case 'lightIntensityDesc':
          sortedData = data.sort((a, b) => b.lightIntensity - a.lightIntensity);
          break;
        case 'none':
          sortedData = data;
          break;
      }

      if(sortedData.length === 0) {
        alert('Không có dữ liệu phù hợp');
        return;
      }

      //console.log(data, airQualityHistoryFiltered);
      airQualityHistoryFiltered = sortedData

      console.log(sortedData, airQualityHistoryFiltered, airQualityHistory);

      // render 
      renderPage(0);
    }

    // Khởi tạo hiển thị trang đầu tiên
    renderPage(0);

    // Sự kiện nút lọc
    document.getElementById('applyFilter').addEventListener('click', filterData);

    // sự kiến nút sắp xếp
    document.getElementById('applySort').addEventListener('click', sortData);

    // Sự kiện cho các nút navbar
    document.getElementById('homePage').addEventListener('click', function () {
      window.location.href = 'index.html';
    });

    document.getElementById('deviceHistoryBtn').addEventListener('click', function () {
      window.location.href = 'device.html';
    });

    document.getElementById('information').addEventListener('click', () => {
      window.location.href = 'info.html';
    })
  </script>
</body>

</html>